/******************************************************************
	SCRIPT CREADO POR MG.SC.ING. SISTEMAS HAROLD N. COILA VILLENA
	JEFE DE LA UNIDAD DE ESTADISTICA E INFORMATICA 2022
*******************************************************************/
USE [BDHIS_MINSA]; SET LANGUAGE SPANISH; DECLARE @hAnioAct VARCHAR(4); SET @hAnioAct=YEAR(GETDATE());
DECLARE @hFechaInicio VARCHAR(8),@hFechaFin VARCHAR(8),@hFechaHoy VARCHAR(8)=REPLACE(CAST(GETDATE() AS Date),'-','');
/******************************************************************
	DESIGNE LOS FILTROS QUE DESEA OBVIAR A CONTINUACION
	AGREGANDO '-- ', sin comillas ANTES DE ETIQUETA 'SET'
*******************************************************************/
DROP TABLE IF EXISTS #TMP_TABLA_GESTANTES_Z349_Z359
SET @hFechaInicio = '20190101';
SET @hFechaFin = '20220101';


SELECT
	DISTINCT ID_CITA
INTO
	#TMP_TABLA_GESTANTES_Z349_Z359
FROM
	NOMINAL_TRAMA_NUEVO
WHERE
	CODIGO_ITEM IN ('Z3491', 'Z3492', 'Z3493', 'Z3591', 'Z3592', 'Z3593')
	AND
	FECHA_ATENCION>=@hFechaInicio AND FECHA_ATENCION<=@hFechaFin

SELECT
	TNum.ANIO AS AÃ‘O, 
	TNum.Mes AS MES, 
	TNum.MICRORED AS MICRORED, 
	TNum.NOMBRE_ESTABLECIMIENTO AS ESTABLECIMIENTO,
	TNum.NUMERO_DOCUMENTO_PACIENTE AS [DNI PACIENTE],
	TNUM.Fecha_Atencion AS [FECHA DE ATENCION],
	TNum.[1er TRI],
	TNum.[2do TRI],
	TNum.[3er TRI],
	ISNULL(TNum.[TOTAL GESTANTES], 0) as [TOTAL DE GESTANTES], 
	ISNULL(TDen.[TOTAL GESTANTES CON ANEMIA], 0) as [GESTANTES CON ANEMIA],  
	ISNULL(TSup.[GESTANTES SUPLEMENTADA], 0) as [GESTANTES SUPLEMENTADA],
	ISNULL(TRec.[TOTAL GESTANTES RECUPERADAS], 0) as [GESTANTES RECUPERADAS]
FROM
(
	SELECT
		ANIO, 
		UPPER(DATENAME(MONTH,'01/'+MES+'/'+@hAnioAct)) AS [MES],
		IIF(ME.MICRORED='NO PERTENECE A NINGUNA MICRORED','REDESS HNE',ME.MICRORED) AS [MICRORED],
		ME.NOMBRE_ESTABLECIMIENTO, 
		MP.NUMERO_DOCUMENTO_PACIENTE,
		N.FECHA_ATENCION,
		SUM(CASE WHEN(N.CODIGO_ITEM IN ('Z3491', 'Z3591')) THEN 1 ELSE 0 END) AS [1er TRI],
		SUM(CASE WHEN(N.CODIGO_ITEM IN ('Z3492', 'Z3592')) THEN 1 ELSE 0 END) AS [2do TRI],
		SUM(CASE WHEN(N.CODIGO_ITEM IN ('Z3493', 'Z3593')) THEN 1 ELSE 0 END) AS [3er TRI],
		COUNT(DISTINCT MP.NUMERO_DOCUMENTO_PACIENTE) AS [TOTAL GESTANTES]
	FROM
		NOMINAL_TRAMA_NUEVO AS N
		INNER JOIN MAESTRO_HIS_ESTABLECIMIENTO AS ME ON N.ID_ESTABLECIMIENTO = ME.ID_ESTABLECIMIENTO
		INNER JOIN MAESTRO_PACIENTE AS MP ON N.ID_PACIENTE = MP.ID_PACIENTE
	WHERE
		N.FECHA_ATENCION>=@hFechaInicio AND N.FECHA_ATENCION<=@hFechaFin
		AND
		N.ID_CITA IN (
						SELECT 
							DISTINCT ID_CITA 
						FROM 
							#TMP_TABLA_GESTANTES_Z349_Z359
					) AND
		N.CODIGO_ITEM IN ('Z3491', 'Z3492', 'Z3493', 'Z3591', 'Z3592', 'Z3593')
	GROUP BY
		N.ANIO, 
		N.MES, 
		ME.MICRORED, 
		ME.NOMBRE_ESTABLECIMIENTO,
		MP.NUMERO_DOCUMENTO_PACIENTE,
		N.FECHA_ATENCION
) AS TNum

LEFT JOIN
(
	SELECT
		ANIO, 
		UPPER(DATENAME(MONTH,'01/'+MES+'/'+@hAnioAct)) AS [MES],
		IIF(ME.MICRORED='NO PERTENECE A NINGUNA MICRORED','REDESS HNE',ME.MICRORED) AS [MICRORED],
		ME.NOMBRE_ESTABLECIMIENTO, 
		MP.NUMERO_DOCUMENTO_PACIENTE,
		N.FECHA_ATENCION,
		COUNT(DISTINCT MP.NUMERO_DOCUMENTO_PACIENTE) AS [TOTAL GESTANTES CON ANEMIA]
	FROM
		NOMINAL_TRAMA_NUEVO AS N
		INNER JOIN MAESTRO_HIS_ESTABLECIMIENTO AS ME ON N.ID_ESTABLECIMIENTO = ME.ID_ESTABLECIMIENTO
		INNER JOIN MAESTRO_PACIENTE AS MP ON N.ID_PACIENTE = MP.ID_PACIENTE
	WHERE
		N.FECHA_ATENCION>=@hFechaInicio AND N.FECHA_ATENCION<=@hFechaFin
		AND
		N.ID_CITA IN (
						SELECT 
							DISTINCT ID_CITA 
						FROM 
							#TMP_TABLA_GESTANTES_Z349_Z359
					) AND
		N.CODIGO_ITEM IN ('O990', 'D509', 'D500', 'D508', 'D649') AND
		N.TIPO_DIAGNOSTICO = 'D'
	GROUP BY
		N.ANIO, 
		N.MES, 
		ME.MICRORED, 
		ME.NOMBRE_ESTABLECIMIENTO,
		MP.NUMERO_DOCUMENTO_PACIENTE,
		N.FECHA_ATENCION
) AS TDen
ON TNum.Anio = TDen.Anio AND
	TNum.Mes = TDen.Mes AND 
	TNum.MICRORED = TDen.MICRORED AND 
	TNum.NOMBRE_ESTABLECIMIENTO = TDen.NOMBRE_ESTABLECIMIENTO AND
	TNum.NUMERO_DOCUMENTO_PACIENTE = TDen.NUMERO_DOCUMENTO_PACIENTE AND
	TNum.FECHA_ATENCION = TDen.FECHA_ATENCION
LEFT JOIN
(
	SELECT
		ANIO, 
		UPPER(DATENAME(MONTH,'01/'+MES+'/'+@hAnioAct)) AS [MES],
		IIF(ME.MICRORED = 'NO PERTENECE A NINGUNA MICRORED', 'HOSPITAL', ME.MICRORED) AS MICRORED, 
		ME.NOMBRE_ESTABLECIMIENTO, 
		MP.NUMERO_DOCUMENTO_PACIENTE,
		N.FECHA_ATENCION,
		COUNT(DISTINCT MP.NUMERO_DOCUMENTO_PACIENTE) AS [GESTANTES SUPLEMENTADA]
	FROM
		NOMINAL_TRAMA_NUEVO AS N
		INNER JOIN MAESTRO_HIS_ESTABLECIMIENTO AS ME ON N.ID_ESTABLECIMIENTO = ME.ID_ESTABLECIMIENTO
		INNER JOIN MAESTRO_PACIENTE AS MP ON N.ID_PACIENTE = MP.ID_PACIENTE
	WHERE
		N.FECHA_ATENCION>=@hFechaInicio AND N.FECHA_ATENCION<=@hFechaFin
		AND
		N.ID_CITA IN (
						SELECT 
							DISTINCT ID_CITA 
						FROM 
							#TMP_TABLA_GESTANTES_Z349_Z359
					) AND
		N.CODIGO_ITEM IN ('59401.04') AND
		N.TIPO_DIAGNOSTICO = 'D'
	GROUP BY
		N.ANIO, 
		N.MES, 
		ME.MICRORED, 
		ME.NOMBRE_ESTABLECIMIENTO,
		MP.NUMERO_DOCUMENTO_PACIENTE,
		N.FECHA_ATENCION
) AS TSup
ON TNum.Anio = TSup.Anio AND
	TNum.Mes = TSup.Mes AND 
	TNum.MICRORED = TSup.MICRORED AND 
	TNum.NOMBRE_ESTABLECIMIENTO = TSup.NOMBRE_ESTABLECIMIENTO AND
	TNum.NUMERO_DOCUMENTO_PACIENTE = TSup.NUMERO_DOCUMENTO_PACIENTE AND
	TNum.FECHA_ATENCION = TSup.FECHA_ATENCION
LEFT JOIN
(
	SELECT
		N.ANIO, 
		UPPER(DATENAME(MONTH,'01/'+MES+'/'+@hAnioAct)) AS [MES],
		IIF(ME.MICRORED = 'NO PERTENECE A NINGUNA MICRORED', 'HOSPITAL', ME.MICRORED) AS MICRORED, 
		ME.NOMBRE_ESTABLECIMIENTO,
		MP.NUMERO_DOCUMENTO_PACIENTE,
		N.FECHA_ATENCION,
		COUNT(DISTINCT MP.NUMERO_DOCUMENTO_PACIENTE) AS [TOTAL GESTANTES RECUPERADAS]
	FROM
		NOMINAL_TRAMA_NUEVO AS N
		INNER JOIN MAESTRO_HIS_ESTABLECIMIENTO AS ME ON N.ID_ESTABLECIMIENTO = ME.ID_ESTABLECIMIENTO
		INNER JOIN MAESTRO_PACIENTE AS MP ON N.ID_PACIENTE = MP.ID_PACIENTE
	WHERE
		N.FECHA_ATENCION>=@hFechaInicio AND N.FECHA_ATENCION<=@hFechaFin
		AND
		N.ID_CITA IN (
						SELECT 
							DISTINCT ID_CITA 
						FROM 
							#TMP_TABLA_GESTANTES_Z349_Z359
					) AND
		N.CODIGO_ITEM IN ('O990', 'D509', 'D500', 'D508', 'D649') AND
		N.VALOR_LAB = 'PR'
	GROUP BY
		N.ANIO, 
		N.MES, 
		ME.MICRORED, 
		ME.NOMBRE_ESTABLECIMIENTO,
		MP.NUMERO_DOCUMENTO_PACIENTE,
		N.FECHA_ATENCION
) AS TRec
ON TNum.Anio = TRec.Anio AND
	TNum.Mes = TRec.Mes AND 
	TNum.MICRORED = TRec.MICRORED AND 
	TNum.NOMBRE_ESTABLECIMIENTO = TRec.NOMBRE_ESTABLECIMIENTO AND
	TNum.NUMERO_DOCUMENTO_PACIENTE = TRec.NUMERO_DOCUMENTO_PACIENTE AND
	TNum.FECHA_ATENCION = TRec.FECHA_ATENCION
ORDER BY
	TNum.ANIO,
	TNum.MES,
	TNum.MICRORED,
	TNUM.Nombre_Establecimiento